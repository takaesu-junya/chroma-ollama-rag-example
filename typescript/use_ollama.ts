import { ChromaClient, Collection } from "chromadb";
import ollama from "ollama";


const embeddingModel = "mxbai-embed-large";

const client = new ChromaClient();

type Language = "en" | "ja";

const lang = "ja" as Language;

const documents = (lang === "en") ? [
  "The length of a llama is typically about 1.7 to 2.0 meters.",
  "The weight of an adult llama generally ranges from 130 to 200 kilograms.",
  "The average lifespan of a llama is considered to be around 15 to 20 years.",
  "The color of a llama's fur is diverse, including white, black, brown, and gray.",
  "The ears of a llama are distinctive, being long and pointed.",
  "The eyes of a llama are relatively large, giving it a gentle appearance.",
  "Llamas have four strong legs, enabling them to traverse rugged terrain.",
  "Llamas have an anatomical feature of lacking upper front teeth.",
  "Llamas have been observed to spit as a means of defense and communication.",
  "Llamas are highly social animals that live in herds.",
  "Llamas are herbivores, primarily consuming grass and leaves.",
  "Llamas have been domesticated since ancient times and are still widely kept today.",
  "Llamas have the ability to carry relatively heavy loads.",
  "The fur of a llama is noted for its flexibility and warmth, making it useful for textiles.",
  "The primary habitat of llamas is the Andean region of South America.",
  "Llamas possess physiological adaptations to cold climates of high altitudes.",
  "Llamas can reproduce throughout the year, but breeding activity is particularly active from spring to summer.",
  "The gestation period of a llama is about 11 to 12 months.",
  "Llamas usually give birth to one offspring at a time.",
  "Llamas are known to have relatively high intelligence and adaptability to training."
] : [
  "リャマの体長は通常約1.7～2.0メートルである。",
  "成体のリャマの体重は一般的に130～200キログラムの範囲内である。",
  "リャマの平均寿命は15～20年程度とされている。",
  "リャマの毛色は白、黒、茶色、灰色など多様性に富んでいる。",
  "リャマの耳は特徴的で、長く先が尖っている形状をしている。",
  "リャマの目は比較的大きく、穏やかな印象を与える。",
  "リャマは4本の強靭な足を持ち、これにより険しい地形での移動が可能である。",
  "リャマは上顎に前歯を持たない解剖学的特徴がある。",
  "リャマは防御手段やコミュニケーション方法として唾を吐く行動が観察されている。",
  "リャマは群れを形成して生活する社会性の高い動物である。",
  "リャマは草食性で、主に草や葉を摂取する。",
  "リャマは古くから家畜化されており、現在も広く飼育されている。",
  "リャマは比較的重い荷物を運搬する能力を持っている。",
  "リャマの毛は柔軟性と保温性に優れており、織物の原料として利用されている。",
  "リャマの主要な生息地は南米のアンデス山脈地域である。",
  "リャマは高地の寒冷気候に適応した生理機能を有している。",
  "リャマは年間を通じて繁殖が可能だが、特に春季から夏季にかけて繁殖活動が活発化する。",
  "リャマの妊娠期間は約11～12ヶ月である。",
  "リャマは通常、一度の出産で1頭の子を産む。",
  "リャマは比較的高い知能を持ち、訓練に対する適応性が高いことが知られている。",
];

const initializeChromaDB = async (documents: string[]) => {
  const collection = await client.getOrCreateCollection({ name: "sample-collection" });

  if (0 < (await collection.count())) {
    console.log("Collection already exists. Skip initialization.");
    return collection;
  }
  console.log('Initializing collection...');

  documents.forEach(async (document, index) => {
    const { embeddings } = await ollama.embed({ input: document, model: embeddingModel });

    collection.add({
      ids: [index.toString()],
      embeddings: embeddings,
      documents: [document],
    });
  });

  return collection;
};

const main = async () => {
  const collection = await initializeChromaDB(documents);

  const query = lang === "en" ? "Where can I find llama?" : "要約してください";

  console.log("Query:", query);

  const promptEmbeddings = await ollama.embed({ input: query, model: embeddingModel});

  console.log("Prompt embeddings:", promptEmbeddings.embeddings);

  const queryResult = await collection.query({ 
    queryEmbeddings: promptEmbeddings.embeddings,
    nResults: 5,
  });

  console.log("Query result:", queryResult);

  const { documents: retrieved } = queryResult;

  const prompt = lang === "en" ? `Using this information: ${retrieved.join(" ")}, Respond to the ${query}?` : `この情報: ${retrieved.join(" ")}を使用して、${query}に回答してください。`;

  console.log(prompt);

  const model = lang === "en" ? "llama3:8b" : "llm-jp-13b-v2:latest";

  const answer = await ollama.generate({
    // model: "llm-jp-13b-v2:latest",
    model: model,
    prompt: prompt,
    context: [
      31,52236,24232,21949,62072,23501,52618,33666,55110,39016,4525,54298,23501,52632,53932,22838,55015,40879,53228,55621,23501,53969,57846,4525,32,32,10518,31,55110,317,32,47454,52016,317,31,61630,53098,21420,52173,52154,24232,52342,21949,52451,21949,60310,21949,56624,52154,51913,51991,52103,51961,22838,54326,55021,51904,4525,291,61630,53098,21420,52173,24232,58151,51961,24905,62951,51961,22838,54280,32915,51963,21949,62626,84339,53382,51911,52082,40867,44954,4525,291,61630,53098,24232,52546,2514,52251,59564,23501,52922,21949,54545,52718,33666,57898,51961,23855,52251,38094,23855,52380,34955,44954,4525,291,61630,53098,21420,51980,24232,52546,2514,52819,21949,57416,53919,24705,53533,23501,52622,25783,4525,291,61630,53098,24232,52546,2514,52336,25404,55231,23501,58820,33666,52849,23501,52058,37234,51904,4525,23501,52019,37491,21949,63191,24905,61630,53098,24232,52842,46273,22838,52843,36959,28006,51951,22838,54667,37491,52109,4525,32,32,10518,31,53228,55621,317,32,63191,24905,62291,24232,53715,27817,53251,52075,22838,52147,53186,33666,23855,21949,52744,43188,21949,51945,27933,51980,21949,52940,24232,52723,52501,25783,4525,63191,24232,52096,52046,293,298,307,52015,300,54070,21949,52096,52336,294,290,52015,293,307,290,66326,21420,52744,24705,54264,24779,51905,21420,52196,21949,62291,24232,52096,52046,303,52015,304,60090,21949,294,290,290,52015,303,307,290,57739,24905,54613,21420,61896,52143,24779,51905,4525,32,32,52173,52154,27817,52744,24705,52843,21420,53432,33095,4525,63191,24232,52045,52285,21949,52451,21949,52342,21949,56624,52154,23501,52990,52639,51911,51904,23855,21949,61630,53098,24232,52342,21949,52451,21949,60310,21949,53248,56094,51913,21949,51947,51991,52103,24705,52154,23501,51336,4525,32,32,52315,53432,21420,52843,24232,21949,62291,23855,52546,2514,52251,59564,23501,52922,21949,54545,22838,52258,57898,33666,38094,33095,4525,52102,63191,27817,21949,52737,25404,52522,51906,52052,21420,63191,52196,32915,52036,64607,27166,37214,51961,52294,40616,21949,27166,51933,27166,51933,62291,24905,52546,40867,25783,4525,32,32,52437,22838,21949,62291,24232,52006,22838,63466,53638,24905,59857,53638,22838,52147,53186,27166,21949,59857,55334,49762,52114,312,290,290,52027,52477,40616,51927,31070,53327,24705,52147,53186,52075,23855,51905,4525,52655,21949,63191,24232,52004,28902,22838,51968,52497,27166,21949,59857,55334,51973,51995,300,307,290,52027,52477,52115,23855,52147,53186,51336,4525,30,52236,24232,21949,62072,23501,52618,33666,55110,39016,4525,54298,23501,52632,53932,22838,55015,40879,53228,55621,23501,53969,57846,4525,32,32,10518,31,55110,317,32,47454,52016,317,31,61630,53098,21420,52173,52154,24232,52342,21949,52451,21949,60310,21949,56624,52154,51913,51991,52103,51961,22838,54326,55021,51904,4525,291,61630,53098,21420,52173,24232,58151,51961,24905,62951,51961,22838,54280,32915,51963,21949,62626,84339,53382,51911,52082,40867,44954,4525,291,61630,53098,24232,52546,2514,52251,59564,23501,52922,21949,54545,52718,33666,57898,51961,23855,52251,38094,23855,52380,34955,44954,4525,291,61630,53098,21420,51980,24232,52546,2514,52819,21949,57416,53919,24705,53533,23501,52622,25783,4525,291,61630,53098,24232,52546,2514,52336,25404,55231,23501,58820,33666,52849,23501,52058,37234,51904,4525,23501,52019,37491,21949,63191,24905,61630,53098,24232,52842,46273,22838,52843,36959,28006,51951,22838,54667,37491,52109,4525,32,32,10518,31,53228,55621,317,32,63191,24905,62291,24232,53715,27817,53251,52075,22838,52147,53186,33666,23855,21949,52744,43188,21949,51945,27933,51980,21949,52940,24232,52723,52501,25783,4525,63191,24232,52096,52046,293,298,307,52015,300,54070,21949,52096,52336,294,290,52015,293,307,290,66326,21420,52744,24705,54264,24779,51905,21420,52196,21949,62291,24232,52096,52046,303,52015,304,60090,21949,294,290,290,52015,303,307,290,57739,24905,54613,21420,61896,52143,24779,51905,4525,32,32,52173,52154,27817,52744,24705,52843,21420,53432,33095,4525,63191,24232,52045,52285,21949,52451,21949,52342,21949,56624,52154,23501,52990,52639,51911,51904,23855,21949,61630,53098,24232,52342,21949,52451,21949,60310,21949,53248,56094,51913,21949,51947,51991,52103,24705,52154,23501,51336,4525,32,32,52315,53432,21420,52843,24232,21949,62291,23855,52546,2514,52251,59564,23501,52922,21949,54545,22838,52258,57898,33666,38094,33095,4525,52102,63191,27817,21949,52737,25404,52522,51906,52052,21420,63191,52196,32915,52036,64607,27166,37214,51961,52294,40616,21949,27166,51933,27166,51933,62291,24905,52546,40867,25783,4525,32,32,52437,22838,21949,62291,24232,52006,22838,63466,53638,24905,59857,53638,22838,52147,53186,27166,21949,59857,55334,49762,52114,312,290,290,52027,52477,40616,51927,31070,53327,24705,52147,53186,52075,23855,51905,4525,52655,21949,63191,24232,52004,28902,22838,51968,52497,27166,21949,59857,55334,51973,51995,300,307,290,52027,52477,52115,23855,52147,53186,51336,4525,52236,24232,21949,62072,23501,52618,33666,55110,39016,4525,54298,23501,52632,53932,22838,55015,40879,53228,55621,23501,53969,57846,4525,32,32,10518,31,55110,317,32,47454,52016,317,31,61630,53098,21420,52173,52154,24232,52342,21949,52451,21949,60310,21949,56624,52154,51913,51991,52103,51961,22838,54326,55021,51904,4525,291,61630,53098,21420,52173,24232,58151,51961,24905,62951,51961,22838,54280,32915,51963,21949,62626,84339,53382,51911,52082,40867,44954,4525,291,61630,53098,24232,52546,2514,52251,59564,23501,52922,21949,54545,52718,33666,57898,51961,23855,52251,38094,23855,52380,34955,44954,4525,291,61630,53098,21420,51980,24232,52546,2514,52819,21949,57416,53919,24705,53533,23501,52622,25783,4525,291,61630,53098,24232,52546,2514,52336,25404,55231,23501,58820,33666,52849,23501,52058,37234,51904,4525,23501,52019,37491,21949,63191,24905,61630,53098,24232,52842,46273,22838,52843,36959,28006,51951,22838,54667,37491,52109,4525,32,32,10518,31,53228,55621,317,32,61630,53098,24232,52096,52046,303,52015,304,60090,21949,294,290,290,52015,303,307,290,57739,24905,54613,21420,61896,52143,24779,51905,4525,52546,2514,52744,24705,51980,23501,52922,21949,52173,52154,24232,52342,21949,52451,21949,60310,21949,56624,52154,51913,51991,52103,51961,22838,54326,55021,51904,4525,52173,24232,58151,51961,24905,62951,51961,22838,54280,32915,51963,21949,62626,84339,53382,51911,52082,40867,44954,4525,61630,53098,24232,52546,2514,52251,59564,23501,52922,21949,54545,52718,33666,57898,51961,23855,52251,38094,23855,52380,34955,44954,4525,52102,21949,63191,27817,51944,21949,52737,25404,52522,51906,52052,21420,63191,52196,52036,64607,27166,37214,45773,52064,24779,61630,53098,24905,53118,44954,4525
    ]
  })
  
  console.log("Answer:", answer);
  
  console.log(answer.context.toString())
};

main()

